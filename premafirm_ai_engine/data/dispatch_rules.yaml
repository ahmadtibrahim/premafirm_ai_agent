################################################################################
# MASTER DISPATCH RULES â€“ PRODUCTION YAML
# Notes:
# - No hard-coded system identity (timezone, home base, etc.). Read from Odoo.
# - Leave Yard At is a CRM field (lead/opportunity). Confirm technical field name.
# - Product selection for CAN/USA is based on CUSTOMER country (partner.country_id),
#   NOT pickup/delivery countries (because tax rules).
# - HOS profile selection is based on where the truck operates (route touches USA => USA HOS).
# - MapBox routing must be truck-safe using dynamic fleet.vehicle specs.
################################################################################

_meta:
  version: "2026.02.20"
  intent: "Unified dispatch, booking, compliance, routing, and product-selection rules"

data_sources:
  odoo:
    home_base_source_note: >
      Home base location is stored in your Odoo database (your saved home location).
      Developer must confirm where it is stored (company/partner/address/custom model).
    vehicle_source:
      model: fleet.vehicle
      fields_note:
        - "work_start_at (daily start)"
        - "vehicle specs for routing: height/weight/length/width/axles (map actual field names)"
    customer_source:
      model: res.partner
      fields_note:
        - "partner_id.country_id drives tax product selection"
    crm_source:
      model: crm.lead
      fields_note:
        - "Leave Yard At is a CRM custom field; confirm technical name"

routing_engine:
  provider: MapBox
  truck_routing_required: true
  vehicle_spec_source:
    model: fleet.vehicle
    mapping_note: "Map these placeholders to actual Odoo fields."
    spec_fields:
      height_m: "fleet.vehicle.<MAP_ME>"
      weight_kg: "fleet.vehicle.<MAP_ME>"
      length_m: "fleet.vehicle.<MAP_ME>"
      width_m: "fleet.vehicle.<MAP_ME>"
      axle_count: "fleet.vehicle.<MAP_ME>"
  constraints:
    avoid_low_bridges: true
    avoid_weight_restricted_roads: true
    avoid_restricted_tunnels: true
  required_outputs:
    - distance_km
    - duration_minutes
    - polyline_geometry
    - border_crossings_if_any
  midpoint_logic: "Derive midpoint from route geometry for weather checkpoint."

email_intake_engine:
  scan_subject: true
  scan_body: true
  scan_attachments: true
  use_ocr_for_pdf: true

  extract_fields:
    - pickup_address
    - delivery_address
    - pickup_window_start
    - pickup_window_end
    - delivery_due_by
    - delivery_window_start
    - delivery_window_end
    - pallet_count
    - weight
    - commodity
    - temperature_requirement
    - rate_type
    - number_of_stops
    - multiple_bol

  temperature_detection:
    method: keyword_weighted_scoring
    confidence_threshold: 0.6
    reefer_keywords:
      - reefer
      - temperature controlled
      - temp controlled
      - chilled
      - frozen
      - keep frozen
      - keep refrigerated
      - maintain temperature
      - 2-8c
      - -18c
      - cold chain
      - perishable
      - produce
      - meat
      - dairy
      - pharma
      - vaccine
      - ice cream
    dry_keywords:
      - dry
      - general freight
      - ambient
      - non-perishable
      - no temp required
      - machinery
      - equipment
      - steel
      - lumber
      - auto parts
    if_uncertain: flag_for_manual_review

  accessorial_detection:
    liftgate_keywords: [liftgate, "no dock", "tailgate required"]
    inside_delivery_keywords: ["inside delivery", "white glove", "bring inside"]

job_classification:
  freight_structure_detection:
    rules:
      - "if multiple_bol == true -> LTL"
      - "if rate_type == 'stop_rate' -> LTL"
      - "if pallet_count >= 8 AND dedicated_truck == true -> FTL"
      - "if pallet_count < 8 AND number_of_stops > 1 -> LTL"
      - "else -> FTL"

product_selection_engine:
  important_note: >
    Select CAN/USA product templates based on CUSTOMER country for tax rules,
    not route geography.
  customer_country_source:
    model: res.partner
    note: "Use sale.order.partner_id.country_id or crm.lead.partner_id.country_id."
  mapping_by_customer_country:
    USA:
      FTL: { Dry: "FTL - Freight Service - USA", Reefer: "FTL - Freight Service - USA" }
      LTL: { Dry: "LTL - Freight Service - USA", Reefer: "LTL - Freight Service - USA" }
    Canada:
      FTL: { Dry: "FTL Freight Service - Canada", Reefer: "FTL Freight Service - Canada" }
      LTL: { Dry: "LTL Freight Service - Canada", Reefer: "LTL Freight Service - Canada" }
  accessorials:
    Liftgate: "Liftgate"
    Inside_Delivery: "Inside Delivery"
  odoo_target:
    model: sale.order.line
    field: product_id
    critical_note: "Always use product.product ID (variant). Never template_id."

leave_yard_and_shift_start:
  crm_field_note: >
    Leave Yard At is in CRM (lead/opportunity). Confirm technical field name.
  pre_trip_inspection_minutes: 15
  shift_start_definition: "on_duty starts at Leave Yard At"
  default_anchor_when_no_time_windows:
    source: "fleet.vehicle.work_start_at"
    note: "If broker provides no pickup/delivery time constraints, anchor schedule to vehicle work start."

time_window_scheduler:
  purpose: "Use broker-provided windows/deadlines when present; otherwise schedule from vehicle work start."
  priority_of_constraints:
    - "delivery_due_by (hard deadline)"
    - "delivery_window_start/end"
    - "pickup_window_start/end"
    - "default_start = fleet.vehicle.work_start_at"
  rules:
    if_pickup_window_provided: "arrive within pickup window"
    if_delivery_deadline_provided: "backward schedule from delivery deadline"
    if_both_pickup_window_and_delivery_deadline: "must satisfy both; if not feasible -> manual review"
    if_no_windows_provided: "forward schedule from vehicle work start"
  leave_yard_calculation:
    formula: >
      leave_yard_at =
        first_required_arrival_time
        - travel_time_home_to_first_stop
        - pre_trip_inspection_minutes
    constraints:
      - "leave_yard_at >= fleet.vehicle.work_start_at; otherwise shift later + warn"
      - "include HOS safety buffer"
  default_service_times:
    avg_stop_time_minutes: 35
    default_loading_minutes: 30
    default_unloading_minutes: 30

hos_engine:
  note: >
    HOS shift start equals Leave Yard At.
    On-duty includes pre-trip, fueling, loading/unloading, waiting while responsible.
  safety_buffer_minutes: 30
  jurisdiction_switching:
    if_route_contains_USA: USA
    else: CANADA
  profiles:
    CANADA:
      max_drive_hours: 13
      max_on_duty_hours: 14
      max_elapsed_window_hours: 16
      min_consecutive_off_duty_hours: 8
      mandatory_30_min_break_after_drive_hours: null
    USA:
      max_drive_hours: 11
      max_on_duty_hours: 14
      max_elapsed_window_hours: 14
      min_consecutive_off_duty_hours: 10
      mandatory_30_min_break_after_drive_hours: 8
  operational_preferences:
    fuel_break_after_drive_hours: 6
    fuel_break_duration_minutes: 30
    fuel_break_counts_as_on_duty: true

cross_border_logic:
  border_buffer_minutes: 120
  apply_if: "any_route_segment_in_USA == true"
  note: "Border buffer counts as on-duty time."

weather_integration:
  provider: WeatherAPI.com
  checkpoints: [home_base, pickup, midpoint, destination]
  risk_scoring:
    rain: 5
    snow: 15
    ice: 25
    blizzard: 40
    wind_above_60_kmh: 15
    visibility_below_1_km: 20
  risk_levels:
    "0-10": LOW
    "11-20": MODERATE
    "21-35": HIGH
    "36+": SEVERE
  actions:
    LOW: no_action
    MODERATE: display_warning
    HIGH: suggest_rate_increase
    SEVERE: require_manual_confirmation

cost_model:
  fuel_cost_km_dry: 0.55
  fuel_cost_km_reefer: 0.63
  maintenance_cost_km: 0.22
  insurance_daily: 95
  overhead_daily: 60
  reefer_daily_cost: 18
  target_net_profit_per_day: 450

deadhead_rules:
  max_deadhead_percent_of_loaded: 0.35
  absolute_max_deadhead_km: 70
  warning_only: true
  note: "No auto-reject; warn and show profit/hour impact."

broker_scoring:
  base_score: 50
  warning_below_score: 45
  priority_above_score: 75
  note: "Weights come from broker history; thresholds are enforced here."

profit_calculation_logic:
  note: "Day-level economics"
  steps:
    - "total_km = loaded_km + deadhead_km + return_home_km"
    - "fuel_cost = total_km * applicable_fuel_cost_km"
    - "maintenance_cost = total_km * maintenance_cost_km"
    - "daily_fixed = insurance_daily + overhead_daily + (reefer_daily_cost if reefer)"
    - "gross_profit = revenue - fuel_cost - maintenance_cost"
    - "net_day_profit = gross_profit - daily_fixed"
    - "revenue_per_hour = revenue / total_estimated_hours"
  warnings:
    if_net_day_profit_below_target: display_profit_warning
    if_revenue_per_hour_below_minimum: display_hourly_warning
    if_deadhead_rules_exceeded: display_deadhead_warning

booking_decision_output:
  no_auto_reject_policy: true
  outputs:
    - recommended_schedule
    - leave_yard_at
    - hos_compliance_status
    - window_feasibility_status
    - weather_risk_level_and_notes
    - profit_estimate_and_revenue_per_hour
    - selected_service_product_id
    - selected_accessorial_product_ids
  manual_review_triggers:
    - temperature_detection_uncertain
    - time_windows_infeasible
    - SEVERE_weather
    - HOS_near_limit
